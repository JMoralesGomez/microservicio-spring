trigger:
- feature-ms-joaquinMorales-mensaje

pool:
  vmImage: ubuntu-latest
  displayName: Build

steps:
- task: Gradle@3
  inputs:
    gradleWrapperFile: 'gradlew'
    tasks: 'build jacocoTestReport jacocoTestCoverageVerification'
    publishJUnitResults: true
    testResultsFiles: '**/TEST-*.xml'
    javaHomeOption: 'JDKVersion'
    sonarQubeRunAnalysis: false
    spotBugsAnalysis: false
  displayName: Build

- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'JaCoCo'
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/build/jacocoHtml/test/jacocoTestReport.xml'
    reportDirectory: '$(System.DefaultWorkingDirectory)/build/jacocoHtml/test/html/'

#- task: SonarCloudPrepare@1
#  inputs:
#    SonarCloud: 'SonaCloud'
#    organization: 'jmoralesgomez'
#    projectKey: JMoralesGomez_microservicio-spring
#    projectName: 'microservicio-spring'
#  displayName: 'SonarCloud Prepare'

#- task: Gradle@3
#  inputs:
#    gradleWrapperFile: 'gradlew'
#    tasks: 'SonarQube'
#    publishJUnitResults: false
#    javaHomeOption: 'JDKVersion'
#    sonarQubeRunAnalysis: true
#    sqGradlePluginVersionChoice: 'specify'
#    sonarQubeGradlePluginVersion: '3.3'
#    spotBugsAnalysis: false


- task: Docker@2
  inputs:
    containerRegistry: 'Docker'
    command: 'login'

- task: Docker@2
  inputs:
    containerRegistry: 'Docker'
    repository: 'pruebajoaquin/laboratoriofinal'
    command: 'build'
    Dockerfile: '**/Dockerfile'

- task: Docker@2
  inputs:
    containerRegistry: 'Docker'
    repository: 'pruebajoaquin/laboratoriofinal'
    command: 'push'

- task: Kubernetes@1
  inputs:
    connectionType: 'None'
    command: 'apply'
    arguments: '-f deployment app.yaml'
    secretType: 'dockerRegistry'
    containerRegistryType: 'Azure Container Registry'

- script: kubectl port-forward deploy/Test-deployment 8086:8085

- script: 'jmeter -n -t pruebas.jmx -l results.jtl'

- script: |
    echo Aprobaste el Curso
  displayName: 'Aprobaste el Curso'



